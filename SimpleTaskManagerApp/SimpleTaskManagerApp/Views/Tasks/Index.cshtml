@using SimpleTaskManagerApp.ViewModels.AppTask
@model IEnumerable<AppTaskListViewModel>

@{
	ViewData["Title"] = "All Tasks";
}

<h1 class="mt-4">All Tasks</h1>

@* Modal button *@
<button id="load-create-form" class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#createTaskModal">
	+ Create Task
</button>

<table class="table table-bordered rounded border-dark border-2">
	<thead class="table-dark">
		<tr>
			<th>Title</th>
			<th>Status</th>
			<th>CreatedAt</th>
			<th>Due Date</th>
			<th>Actions</th>
		</tr>
	</thead>
	<tbody>
		@foreach (var task in Model)
		{
			<tr>
				<td>@task.Title</td>
				<td>@task.StatusName</td>
				<td>@task.CreatedAt</td>
				<td>@task.DueDate</td>
				<td>
					<a asp-action="Details" asp-route-id="@task.Id" class="btn btn-sm btn-info">Details</a>
					<a asp-action="Edit" asp-route-id="@task.Id" class="btn btn-sm btn-warning">Edit</a>
					<a asp-action="Delete" asp-route-id="@task.Id" class="btn btn-sm btn-danger">Delete</a>
				</td>
			</tr>
		}
	</tbody>
</table>


@* Bootstrap modal *@
<div class="modal fade" id="createTaskModal" tabindex="-1" aria-labelledby="createTaskModalLabel" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="createTaskModalLabel">Create Task</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<div class="modal-body">
				<div id="modal-form-container">
					@*AJAX will load the form here*@

				</div>
			</div>
		</div>
	</div>
</div>

@section Scripts {
	<partial name="_ValidationScriptsPartial" />

	<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
	<script>
		// Load form in modal
		document.getElementById("load-create-form").addEventListener("click", function () {
			fetch("/Tasks/CreatePartial")
				.then(response => response.text())
				.then(html => {
					document.getElementById("modal-form-container").innerHTML = html;

					// flatpickr initalization inside the modal
					flatpickr(".datepicker", {
						enableTime: true,
						dateFormat: "Y-m-d H:i",
						time_24hr: true
					});
				});
		});


		// AJAX submit of the form
		$(document).on('submit', '#createTaskForm', function (e) {
			e.preventDefault();

			var form = $(this);
			$.ajax({
				type: 'POST',
				url: '/Tasks/Create',
				data: form.serialize(),
				success: function () {
					$('#createTaskModal').modal('hide');
					showToast("Task added!");
					location.reload();
				},
				error: function () {
					showToast("Something went wrong!");
				}
			});
		});


		// Toast function
		function showToast(message) {
			const toast = document.createElement('div');
			toast.className = 'toast align-items-center text-bg-primary border-0 show position-fixed bottom-0 end-0 m-4';
			toast.style.zIndex = 10000;
			toast.innerHTML = `
								<div class="d-flex">
									<div class="toast-body">${message}</div>
									<button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
								</div>`;
			document.body.appendChild(toast);
			setTimeout(() => toast.remove(), 3000);
		}
	</script>


}
